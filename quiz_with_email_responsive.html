<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz: Sistema Reprodutor Humano - Agrupamento Muralhas do Minho</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      max-width: 800px;
      width: 100%;
    }
    h1, h2, h3 {
      color: #333;
    }
    .header-info {
      text-align: center;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .header-info h1 {
      color: #4CAF50;
      margin-bottom: 5px;
      font-size: 24px;
    }
    .header-info h2 {
      color: #666;
      margin: 5px 0;
      font-size: 16px;
    }
    .student-info {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    @media (min-width: 600px) {
      .student-info {
        grid-template-columns: 1fr 1fr;
      }
      .container {
        padding: 30px;
        margin-top: 30px;
      }
      .header-info h1 {
        font-size: 28px;
      }
      .header-info h2 {
        font-size: 18px;
      }
    }
    .student-info label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      color: #333;
    }
    .student-info input {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      margin-top: 5px;
    }
    .student-info input:focus {
      border-color: #4CAF50;
      outline: none;
    }
    label, select, button {
      font-size: 16px;
    }
    select {
      padding: 12px;
      margin-top: 5px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      width: 100%;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 15px 20px;
      margin-top: 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.3s ease;
      width: 100%;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .question {
      margin-top: 20px;
    }
    .options button {
      background-color: #2196F3;
      width: 100%;
      text-align: left;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 16px;
      transition: background 0.2s;
      cursor: pointer;
    }
    .options button:hover {
      background-color: #1976D2;
    }
    .options button.selected {
      background-color: #4CAF50;
      border: 3px solid #388E3C;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    .options button.selected:hover {
      background-color: #45a049;
    }
    #timer {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
      color: #d32f2f;
    }
    #progressBar {
      height: 12px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progress {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.4s ease;
    }
    .hidden {
      display: none;
    }
    #resultList p {
      background: #f9f9f9;
      padding: 10px;
      border-left: 5px solid #ccc;
      margin: 8px 0;
      border-radius: 6px;
    }
    #finalScore {
      font-size: 20px;
      padding-top: 10px;
      color: #333;
      text-align: center;
      background: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .incorrect {
      color: red;
      font-weight: bold;
    }
    .user-answer-correct {
      background-color: #d4edda;
      color: #155724;
      font-weight: bold;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #c3e6cb;
    }
    .user-answer-incorrect {
      background-color: #f8d7da;
      color: #721c24;
      font-weight: bold;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #f5c6cb;
    }
    .correct-answer {
      background-color: #d1ecf1;
      color: #0c5460;
      font-weight: bold;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #bee5eb;
    }
    .export-section {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #4CAF50;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    @media (min-width: 600px) {
      .export-section {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      button {
        width: auto;
      }
    }
    .pdf-button {
      background-color: #f44336;
      font-size: 18px;
      padding: 15px 30px;
      margin: 5px;
    }
    .pdf-button:hover {
      background-color: #d32f2f;
    }
    .excel-button {
      background-color: #217346;
      font-size: 18px;
      padding: 15px 30px;
      margin: 5px;
    }
    .excel-button:hover {
      background-color: #1e6b3e;
    }
    .email-button {
      background-color: #0078D4;
      font-size: 18px;
      padding: 15px 30px;
      margin: 5px;
    }
    .email-button:hover {
      background-color: #0063B1;
    }
    .validation-error {
      color: #f44336;
      font-size: 14px;
      margin-top: 5px;
    }
    
    /* Estilos para notifica√ß√µes de status */
    .save-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      transition: all 0.3s ease;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .save-status.success {
      background-color: #4CAF50;
    }
    
    .save-status.error {
      background-color: #f44336;
    }
    
    .save-status.loading {
      background-color: #2196F3;
    }
    
    /* Informa√ß√£o de configura√ß√£o */
    .config-info {
      background-color: #e8f5e8;
      border: 1px solid #4CAF50;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      color: #2e7d32;
    }
    
    .config-info h4 {
      margin-top: 0;
      color: #2e7d32;
    }
    
    /* Configura√ß√£o de email - DESTACADA */
    .email-config {
      background-color: #ffeb3b;
      border: 3px solid #f57c00;
      border-radius: 8px;
      padding: 20px;
      margin: 30px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .email-config h4 {
      margin-top: 0;
      color: #e65100;
      font-size: 20px;
    }
    
    .email-config p {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .email-config input {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 2px solid #f57c00;
      border-radius: 6px;
      font-size: 18px;
      background-color: #fff;
    }
    
    .email-config input:focus {
      border-color: #e65100;
      outline: none;
      box-shadow: 0 0 8px rgba(230, 81, 0, 0.5);
    }
    
    .email-config::before {
      content: "‚ö†Ô∏è IMPORTANTE";
      position: absolute;
      top: -15px;
      left: 20px;
      background-color: #f57c00;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
    }
    
    .email-config-note {
      font-size: 14px;
      color: #e65100;
      font-style: italic;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- Notifica√ß√£o de Status de Salvamento -->
  <div id="saveStatus" class="save-status hidden"></div>

  <div class="container">
    <!-- P√°gina inicial com informa√ß√µes do aluno -->
    <div id="initial" class="initial-page">
      <div class="header-info">
        <h1>Agrupamento Muralhas do Minho</h1>
        <h2>Disciplina: Ci√™ncias Naturais</h2>
        <h2>Professor: Fernando Cruz</h2>
        <h2>Quiz: Sistema Reprodutor Humano</h2>
      </div>
      
      <!-- Informa√ß√µes de configura√ß√£o -->
      <div class="config-info">
        <h4>‚úÖ Sistema de Exporta√ß√£o M√∫ltipla</h4>
        <p>Os resultados deste quiz podem ser exportados para Excel, PDF ou enviados por email.</p>
      </div>
      
      <!-- Configura√ß√£o de email - DESTACADA -->
      <div class="email-config">
        <h4>üìß CONFIGURA√á√ÉO DE EMAIL DO PROFESSOR</h4>
        <p>Insira abaixo o email para onde os resultados ser√£o enviados:</p>
        <input type="email" id="teacherEmail" placeholder="email@exemplo.com" value="turmasvalenca@gmail.com">
        <div class="email-config-note">* Este email ser√° usado como destinat√°rio quando o aluno clicar em "Enviar por Email" ao final do quiz</div>
      </div>
      
      <div class="student-info">
        <label>
          Nome do Aluno:
          <input type="text" id="studentName" placeholder="Digite seu nome completo" required>
          <span id="nameError" class="validation-error hidden">Por favor, digite seu nome</span>
        </label>
        
        <label>
          N√∫mero:
          <input type="number" id="studentNumber" placeholder="N√∫mero do aluno" required>
          <span id="numberError" class="validation-error hidden">Por favor, digite seu n√∫mero</span>
        </label>
        
        <label>
          Turma:
          <input type="text" id="studentClass" placeholder="Ex: 9¬∫A" required>
          <span id="classError" class="validation-error hidden">Por favor, digite sua turma</span>
        </label>
        
        <label>
          Data:
          <input type="date" id="testDate" required>
          <span id="dateError" class="validation-error hidden">Por favor, selecione a data</span>
        </label>
        
        <label>
          Hora:
          <input type="time" id="testTime" required>
          <span id="timeError" class="validation-error hidden">Por favor, selecione a hora</span>
        </label>
      </div>
      
      <button onclick="proceedToConfig()" id="proceedBtn">Prosseguir para Configura√ß√µes</button>
    </div>

    <!-- Configura√ß√µes do quiz -->
    <div id="config" class="hidden">
      <h2>Configura√ß√µes do Quiz</h2>
      <label>Tempo por pergunta:
        <select id="timeSelect">
          <option value="30">30 segundos</option>
          <option value="45">45 segundos</option>
          <option value="60">1 minuto</option>
        </select>
      </label>
      <br><br>
      <label>M√©todo de avan√ßo:
        <select id="modeSelect">
          <option value="auto">Autom√°tico (ap√≥s tempo)</option>
          <option value="manual">Manual (bot√£o "Pr√≥xima")</option>
        </select>
      </label>
      <br><br>
      <button onclick="startQuiz()">Iniciar Quiz</button>
    </div>

    <!-- Quiz -->
    <div id="quiz" class="hidden">
      <div id="timer"></div>
      <div id="progressBar"><div id="progress"></div></div>
      <div id="questionContainer"></div>
      <button id="nextBtn" onclick="nextQuestion()" class="hidden">Pr√≥xima</button>
    </div>

    <!-- Resumo e resultados -->
    <div id="summary" class="hidden">
      <div class="header-info">
        <h1>Agrupamento Muralhas do Minho</h1>
        <h2>Disciplina: Ci√™ncias Naturais - Professor: Fernando Cruz</h2>
        <div id="studentInfo"></div>
      </div>
      
      <h2>Resumo do Quiz - Sistema Reprodutor Humano</h2>
      <div id="resultList"></div>
      <div id="finalScore"></div>
      
      <div class="export-section">
        <button onclick="sendByEmail()" class="email-button" id="emailButton">
          üìß Enviar por Email
        </button>
        <button onclick="exportToExcel()" class="excel-button" id="excelButton">
          üìä Exportar para Excel
        </button>
        <button onclick="exportToPDF()" class="pdf-button">
          üìÑ Exportar para PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // DADOS DAS PERGUNTAS DO QUIZ
    // ==========================================
    const quizData = [
      { q: "Qual √© a principal fun√ß√£o do sistema reprodutor masculino?", o: ["Produzir √≥vulos", "Produzir espermatozoides", "Regular o ciclo menstrual", "Nutrir o embri√£o"], a: 1 },
      { q: "Qual destas gl√¢ndulas produz testosterona?", o: ["Ov√°rios", "P√¢ncreas", "Test√≠culos", "Hip√≥fise"], a: 2 },
      { q: "Qual √© o nome da c√©lula reprodutiva feminina?", o: ["Espermatozoide", "Zigoto", "Embri√£o", "√ìvulo"], a: 3 },
      { q: "Onde ocorre geralmente a fecunda√ß√£o no corpo humano?", o: ["Ov√°rios", "√ötero", "Trompas de Fal√≥pio", "Vagina"], a: 2 },
      { q: "Como se chama a estrutura que alimenta o feto durante a gravidez?", o: ["Placenta", "Ov√°rio", "Test√≠culo", "Hipot√°lamo"], a: 0 },
      { q: "O ciclo menstrual tem, em m√©dia, quantos dias?", o: ["14 dias", "28 dias", "30 dias", "40 dias"], a: 1 },
      { q: "Qual √© o nome da primeira c√©lula formada ap√≥s a fecunda√ß√£o?", o: ["√ìvulo", "Embri√£o", "Feto", "Zigoto"], a: 3 },
      { q: "Qual destas estruturas faz parte do sistema reprodutor feminino?", o: ["P√™nis", "Test√≠culo", "√ötero", "Ves√≠cula biliar"], a: 2 },
      { q: "O que acontece durante a menstrua√ß√£o?", o: ["Libera√ß√£o de espermatozoides", "Elimina√ß√£o do revestimento do √∫tero", "Fecunda√ß√£o do √≥vulo", "Produ√ß√£o de leite materno"], a: 1 },
      { q: "Qual √© a fun√ß√£o dos espermatozoides?", o: ["Iniciar o ciclo menstrual", "Fecundar o √≥vulo", "Produzir hormonas", "Controlar a temperatura corporal"], a: 1 },
      { q: "O que caracteriza a puberdade?", o: ["Crescimento celular", "Produ√ß√£o de hormonas sexuais", "Forma√ß√£o do zigoto", "Envelhecimento"], a: 1 },
      { q: "Qual √© a fun√ß√£o principal dos ov√°rios?", o: ["Produzir espermatozoides", "Liberar √≥vulos e hormonas sexuais", "Nutrir o embri√£o", "Controlar a press√£o arterial"], a: 1 },
      { q: "A gravidez inicia-se com:", o: ["O ciclo menstrual", "A fecunda√ß√£o do √≥vulo", "O nascimento do beb√©", "A produ√ß√£o de leite materno"], a: 1 },
      { q: "Durante a gravidez, o cord√£o umbilical serve para:", o: ["Nutrir o beb√© e fornecer oxig√©nio", "Produzir √≥vulos", "Controlar a temperatura corporal", "Regular o ciclo menstrual"], a: 0 },
      { q: "Qual √© o nome da bolsa que protege o beb√© no √∫tero?", o: ["Placenta", "Trompas de Fal√≥pio", "Bolsa amni√≥tica", "Ves√≠cula seminal"], a: 2 },
      { q: "Qual destas fases representa o desenvolvimento inicial do beb√©?", o: ["Zigoto", "Feto", "Menopausa", "Idade adulta"], a: 0 },
      { q: "Onde se forma o espermatozoide?", o: ["√ötero", "Trompas de Fal√≥pio", "Test√≠culos", "Placenta"], a: 2 },
      { q: "Qual das seguintes etapas ocorre primeiro na reprodu√ß√£o humana?", o: ["Forma√ß√£o do feto", "Crescimento do beb√©", "Fecunda√ß√£o do √≥vulo", "Produ√ß√£o de leite materno"], a: 2 },
      { q: "Em que √≥rg√£o o beb√© se desenvolve antes de nascer?", o: ["Test√≠culo", "Ov√°rio", "√ötero", "Ves√≠cula seminal"], a: 2 },
      { q: "O que acontece durante a fecunda√ß√£o?", o: ["O espermatozoide une-se ao √≥vulo", "O √∫tero elimina o revestimento interno", "O beb√© inicia a produ√ß√£o de leite materno", "O cord√£o umbilical √© formado"], a: 0 },
      { q: "Qual destas hormonas √© essencial para o desenvolvimento dos caracteres sexuais masculinos?", o: ["Estrog√©nio", "Progesterona", "Testosterona", "Insulina"], a: 2 },
      { q: "A reprodu√ß√£o humana √© um processo:", o: ["Assexuado", "Sexuado", "Artificial", "Mec√¢nico"], a: 1 },
      { q: "Qual √© a principal fun√ß√£o dos test√≠culos?", o: ["Produzir √≥vulos", "Produzir espermatozoides e hormonas sexuais", "Controlar a temperatura corporal", "Nutrir o beb√©"], a: 1 },
      { q: "Como se chama o per√≠odo de tempo em que o beb√© se desenvolve no √∫tero?", o: ["Menstrua√ß√£o", "Gesta√ß√£o", "Puberdade", "Zigoto"], a: 1 },
      { q: "Qual destas op√ß√µes N√ÉO faz parte do sistema reprodutor masculino?", o: ["Test√≠culos", "√ötero", "P√™nis", "Ves√≠cula seminal"], a: 1 },
      { q: "Em que idade geralmente ocorre a puberdade?", o: ["Aos 2 anos", "Entre os 10 e 18 anos", "Aos 40 anos", "Ap√≥s os 60 anos"], a: 1 },
      { q: "Qual √© o resultado final da reprodu√ß√£o humana?", o: ["Forma√ß√£o de c√©lulas", "Nascimento de um novo ser humano", "Produ√ß√£o de hormonas", "Produ√ß√£o de leite materno"], a: 1 },
      { q: "Qual √© a c√©lula reprodutiva masculina?", o: ["Espermatoz√≥ide", "Esperma", "Zigoto", "Embri√£o"], a: 0 },
      { q: "Qual √© a fun√ß√£o principal do √∫tero no sistema reprodutor feminino?", o: ["Produzir hormonas", "Proteger os ov√°rios", "Acolher e nutrir o embri√£o", "Liberar √≥vulos"], a: 2 },
      { q: "Onde ocorre normalmente a fecunda√ß√£o?", o: ["√ötero", "Trompas de Fal√≥pio", "Ov√°rio", "Vagina"], a: 1 },
      { q: "Ap√≥s a fecunda√ß√£o, como √© chamado o primeiro est√°gio de desenvolvimento do ser humano?", o: ["Embri√£o", "Feto", "√ìvulo", "Beb√©"], a: 0 },
      { q: "Qual √© a fun√ß√£o da placenta durante a gravidez?", o: ["Controlar os batimentos card√≠acos do beb√©", "Produzir leite materno", "Trocar nutrientes e oxig√©nio entre m√£e e beb√©", "Armazenar c√©lulas reprodutivas"], a: 2 }
    ];

    // ==========================================
    // VARI√ÅVEIS GLOBAIS
    // ==========================================
    let current = 0;
    let userAnswers = [];
    let timer;
    let timePerQuestion;
    let autoMode;
    let studentData = {};

    // ==========================================
    // INICIALIZA√á√ÉO
    // ==========================================
    window.onload = function() {
      const now = new Date();
      document.getElementById('testDate').value = now.toISOString().split('T')[0];
      document.getElementById('testTime').value = now.toTimeString().split(':').slice(0,2).join(':');
      
      // Destacar visualmente o campo de email
      const emailField = document.getElementById('teacherEmail');
      emailField.focus();
      setTimeout(() => {
        emailField.blur();
      }, 1000);
    };

    // ==========================================
    // FUN√á√ÉO PARA ENVIAR POR EMAIL
    // ==========================================
    function sendByEmail() {
      showSaveStatus('loading', 'üìß Preparando email...');
      
      // Desabilitar bot√£o para evitar cliques m√∫ltiplos
      const emailButton = document.getElementById('emailButton');
      const originalText = emailButton.textContent;
      emailButton.disabled = true;
      emailButton.textContent = 'Preparando...';
      
      try {
        // Obter email do professor
        const teacherEmail = document.getElementById('teacherEmail').value.trim();
        if (!teacherEmail) {
          throw new Error('Email do professor n√£o definido');
        }
        
        // Calcular pontua√ß√£o
        let correct = 0;
        userAnswers.forEach((answer, i) => {
          if (answer === quizData[i].a) correct++;
        });
        
        const percent = Math.round((correct / quizData.length) * 100);
        let level = "";
        if (percent < 50) level = "N√£o Satisfaz";
        else if (percent < 70) level = "Satisfaz";
        else if (percent < 90) level = "Satisfaz Bastante";
        else level = "Excelente";
        
        // Criar assunto do email
        const subject = `Resultados Quiz - ${studentData.name} (${studentData.class})`;
        
        // Criar corpo do email
        let body = `Resultados do Quiz: Sistema Reprodutor Humano\n\n`;
        body += `Aluno: ${studentData.name}\n`;
        body += `N√∫mero: ${studentData.number}\n`;
        body += `Turma: ${studentData.class}\n`;
        body += `Data: ${new Date(studentData.date).toLocaleDateString('pt-PT')}\n`;
        body += `Hora: ${studentData.time}\n\n`;
        body += `Pontua√ß√£o: ${percent}% (${correct}/${quizData.length})\n`;
        body += `Avalia√ß√£o: ${level}\n\n`;
        body += `DETALHES DAS RESPOSTAS:\n`;
        
        // Adicionar respostas (limitadas para n√£o exceder o tamanho m√°ximo do mailto)
        body += `\n[Resumo das primeiras 5 perguntas]\n`;
        for (let i = 0; i < 5 && i < quizData.length; i++) {
          const userAnswer = userAnswers[i] !== null ? quizData[i].o[userAnswers[i]] : "Sem resposta";
          const correctAnswer = quizData[i].o[quizData[i].a];
          const isCorrect = userAnswers[i] === quizData[i].a;
          
          body += `\nPergunta ${i + 1}: ${quizData[i].q}\n`;
          body += `Resposta: ${userAnswer} (${isCorrect ? "Correto" : "Incorreto"})\n`;
        }
        
        // Adicionar nota sobre os arquivos
        body += `\n\n---\nNota: Os arquivos PDF e Excel com todas as respostas foram gerados automaticamente. Por favor, anexe-os a este email antes de enviar.`;
        
        // Codificar o corpo do email para URL
        const encodedBody = encodeURIComponent(body);
        const encodedSubject = encodeURIComponent(subject);
        
        // Criar o link mailto
        const mailtoLink = `mailto:${teacherEmail}?subject=${encodedSubject}&body=${encodedBody}`;
        
        // Gerar automaticamente os arquivos PDF e Excel
        exportToPDF();
        setTimeout(() => {
          exportToExcel();
          
          // Abrir o cliente de email ap√≥s gerar os arquivos
          setTimeout(() => {
            // Usar window.open para maior compatibilidade com dispositivos m√≥veis
            window.open(mailtoLink, '_self');
            
            showSaveStatus('success', '‚úÖ Email preparado! Abrindo seu aplicativo de email...');
            
            // Reabilitar bot√£o
            setTimeout(() => {
              emailButton.disabled = false;
              emailButton.textContent = originalText;
            }, 2000);
          }, 1000);
        }, 1000);
        
      } catch (error) {
        console.error('Erro ao preparar email:', error);
        showSaveStatus('error', '‚ùå Erro ao preparar email. Verifique o endere√ßo do professor.');
        
        // Reabilitar bot√£o
        setTimeout(() => {
          emailButton.disabled = false;
          emailButton.textContent = originalText;
        }, 2000);
      }
    }
    
    // ==========================================
    // FUN√á√ÉO PARA EXPORTAR PARA EXCEL
    // ==========================================
    function exportToExcel() {
      showSaveStatus('loading', 'üìä Preparando arquivo Excel...');
      
      // Desabilitar bot√£o para evitar cliques m√∫ltiplos
      const excelButton = document.getElementById('excelButton');
      const originalText = excelButton ? excelButton.textContent : 'Exportar para Excel';
      if (excelButton) {
        excelButton.disabled = true;
        excelButton.textContent = 'Exportando...';
      }
      
      try {
        // Calcular pontua√ß√£o
        let correct = 0;
        userAnswers.forEach((answer, i) => {
          if (answer === quizData[i].a) correct++;
        });
        
        const percent = Math.round((correct / quizData.length) * 100);
        let level = "";
        if (percent < 50) level = "N√£o Satisfaz";
        else if (percent < 70) level = "Satisfaz";
        else if (percent < 90) level = "Satisfaz Bastante";
        else level = "Excelente";
        
        // Criar XML para Excel
        let excelContent = `
          <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
          <head>
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
            <!--[if gte mso 9]>
            <xml>
              <x:ExcelWorkbook>
                <x:ExcelWorksheets>
                  <x:ExcelWorksheet>
                    <x:Name>Resultados Quiz</x:Name>
                    <x:WorksheetOptions>
                      <x:DisplayGridlines/>
                    </x:WorksheetOptions>
                  </x:ExcelWorksheet>
                </x:ExcelWorksheets>
              </x:ExcelWorkbook>
            </xml>
            <![endif]-->
            <style>
              table, th, td {
                border: 1px solid black;
                border-collapse: collapse;
                padding: 5px;
              }
              th {
                background-color: #f2f2f2;
                font-weight: bold;
              }
              .header {
                font-size: 16pt;
                font-weight: bold;
                text-align: center;
                background-color: #e8f5e8;
                color: #2e7d32;
              }
              .correct {
                background-color: #d4edda;
                color: #155724;
              }
              .incorrect {
                background-color: #f8d7da;
                color: #721c24;
              }
            </style>
          </head>
          <body>
            <table>
              <tr class="header">
                <td colspan="7">Agrupamento Muralhas do Minho - Quiz Sistema Reprodutor Humano</td>
              </tr>
              <tr>
                <th>Nome</th>
                <th>N√∫mero</th>
                <th>Turma</th>
                <th>Data</th>
                <th>Hora</th>
                <th>Pontua√ß√£o</th>
                <th>Avalia√ß√£o</th>
              </tr>
              <tr>
                <td>${studentData.name}</td>
                <td>${studentData.number}</td>
                <td>${studentData.class}</td>
                <td>${studentData.date}</td>
                <td>${studentData.time}</td>
                <td>${percent}% (${correct}/${quizData.length})</td>
                <td>${level}</td>
              </tr>
            </table>
            
            <br>
            
            <table>
              <tr class="header">
                <td colspan="4">Detalhes das Respostas</td>
              </tr>
              <tr>
                <th>Pergunta</th>
                <th>Resposta do Aluno</th>
                <th>Resposta Correta</th>
                <th>Resultado</th>
              </tr>
        `;
        
        // Adicionar respostas
        quizData.forEach((q, i) => {
          const userAnswer = userAnswers[i] !== null ? q.o[userAnswers[i]] : "Sem resposta";
          const correctAnswer = q.o[q.a];
          const isCorrect = userAnswers[i] === q.a;
          const resultClass = isCorrect ? "correct" : "incorrect";
          const resultText = isCorrect ? "Correto" : "Incorreto";
          
          excelContent += `
            <tr>
              <td>${q.q}</td>
              <td>${userAnswer}</td>
              <td>${correctAnswer}</td>
              <td class="${resultClass}">${resultText}</td>
            </tr>
          `;
        });
        
        excelContent += `
            </table>
          </body>
          </html>
        `;
        
        // Criar blob e link para download
        const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `Quiz_${studentData.name.replace(/\s+/g, '_')}_${studentData.number}.xls`);
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        document.body.removeChild(link);
        
        showSaveStatus('success', '‚úÖ Arquivo Excel exportado com sucesso!');
      } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        showSaveStatus('error', '‚ùå Erro ao exportar Excel.');
      } finally {
        // Reabilitar bot√£o
        if (excelButton) {
          setTimeout(() => {
            excelButton.disabled = false;
            excelButton.textContent = originalText;
          }, 2000);
        }
      }
    }
    
    // ==========================================
    // FUN√á√ÉO PARA MOSTRAR STATUS
    // ==========================================
    function showSaveStatus(type, message) {
      const statusDiv = document.getElementById('saveStatus');
      statusDiv.className = `save-status ${type}`;
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 4000);
      }
    }

    // ==========================================
    // VALIDA√á√ÉO DE DADOS DO ALUNO
    // ==========================================
    function validateStudentInfo() {
      let isValid = true;
      const fields = ['studentName', 'studentNumber', 'studentClass', 'testDate', 'testTime'];
      
      fields.forEach(field => {
        const element = document.getElementById(field);
        const errorElement = document.getElementById(field.replace('student', '').replace('test', '').toLowerCase() + 'Error');
        
        if (!element.value.trim()) {
          errorElement.classList.remove('hidden');
          isValid = false;
        } else {
          errorElement.classList.add('hidden');
        }
      });
      
      // Validar tamb√©m o email do professor
      const teacherEmail = document.getElementById('teacherEmail').value.trim();
      if (!teacherEmail) {
        showSaveStatus('error', '‚ùå Por favor, defina o email do professor antes de prosseguir');
        isValid = false;
      }
      
      return isValid;
    }

    function proceedToConfig() {
      if (!validateStudentInfo()) {
        return;
      }
      
      // Armazenar dados do estudante
      studentData = {
        name: document.getElementById('studentName').value,
        number: document.getElementById('studentNumber').value,
        class: document.getElementById('studentClass').value,
        date: document.getElementById('testDate').value,
        time: document.getElementById('testTime').value
      };
      
      document.getElementById("initial").classList.add("hidden");
      document.getElementById("config").classList.remove("hidden");
    }

    function startQuiz() {
      document.getElementById("config").classList.add("hidden");
      document.getElementById("quiz").classList.remove("hidden");
      timePerQuestion = parseInt(document.getElementById("timeSelect").value);
      autoMode = document.getElementById("modeSelect").value === "auto";
      showQuestion();
    }

    function showQuestion() {
      const q = quizData[current];
      const container = document.getElementById("questionContainer");
      container.innerHTML = `<div class="question"><h3>Pergunta ${current + 1} de ${quizData.length}: ${q.q}</h3></div>`;
      const options = document.createElement("div");
      options.className = "options";
      q.o.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => selectAnswer(i);
        options.appendChild(btn);
      });
      container.appendChild(options);
      document.getElementById("nextBtn").classList.toggle("hidden", autoMode);
      updateProgressBar();
      if (autoMode) startTimer();
    }

    function updateProgressBar() {
      const progress = document.getElementById("progress");
      const percent = ((current) / quizData.length) * 100;
      progress.style.width = percent + "%";
    }

    function startTimer() {
      let t = timePerQuestion;
      const timerEl = document.getElementById("timer");
      timerEl.textContent = `‚è±Ô∏è Tempo restante: ${t}s`;
      clearInterval(timer);
      timer = setInterval(() => {
        t--;
        timerEl.textContent = `‚è±Ô∏è Tempo restante: ${t}s`;
        if (t <= 0) {
          clearInterval(timer);
          userAnswers.push(null);
          nextQuestion();
        }
      }, 1000);
    }

    function selectAnswer(index) {
      // Remover sele√ß√£o anterior
      document.querySelectorAll('.options button').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Adicionar classe de selecionado √† op√ß√£o escolhida
      document.querySelectorAll('.options button')[index].classList.add('selected');
      
      userAnswers[current] = index;
      if (autoMode) {
        clearInterval(timer);
        setTimeout(() => {
          nextQuestion();
        }, 500); // Pequeno delay para mostrar a sele√ß√£o
      }
    }

    function nextQuestion() {
      current++;
      if (current < quizData.length) {
        showQuestion();
      } else {
        showSummary();
      }
    }

    function showSummary() {
      document.getElementById("quiz").classList.add("hidden");
      document.getElementById("summary").classList.remove("hidden");
      
      // Mostrar informa√ß√µes do estudante
      const studentInfo = document.getElementById("studentInfo");
      studentInfo.innerHTML = `
        <h3>Aluno: ${studentData.name} | N¬∫ ${studentData.number} | Turma: ${studentData.class}</h3>
        <h3>Data: ${new Date(studentData.date).toLocaleDateString('pt-PT')} | Hora: ${studentData.time}</h3>
      `;
      
      let correct = 0;
      let list = "";
      quizData.forEach((q, i) => {
        const user = userAnswers[i];
        const isCorrect = user === q.a;
        if (isCorrect) correct++;
        
        const userAnswerText = user !== null ? q.o[user] : "<em>Sem resposta</em>";
        const userAnswerClass = user !== null ? (isCorrect ? 'user-answer-correct' : 'user-answer-incorrect') : '';
        
        list += `<p><strong>Pergunta ${i + 1}: ${q.q}</strong><br>
        A sua resposta: <span class="${userAnswerClass}">${userAnswerText}</span><br>
        Resposta correta: <span class="correct-answer">${q.o[q.a]}</span><br>
        ${isCorrect ? "<span class='correct'>‚úî Correto</span>" : "<span class='incorrect'>‚úò Incorreto</span>"}</p>`;
      });
      
      const percent = Math.round((correct / quizData.length) * 100);
      let level = "";
      if (percent < 50) level = "N√£o Satisfaz";
      else if (percent < 70) level = "Satisfaz";
      else if (percent < 90) level = "Satisfaz Bastante";
      else level = "Excelente";
      
      document.getElementById("resultList").innerHTML = list;
      document.getElementById("finalScore").innerHTML = `
        <h3>Resultado Final</h3>
        <p>Respostas corretas: ${correct} de ${quizData.length}</p>
        <p>Pontua√ß√£o: <strong>${percent}%</strong></p>
        <p>Avalia√ß√£o: <strong>${level}</strong></p>
      `;
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Configurar fonte
      doc.setFont('helvetica');
      
      // Cabe√ßalho
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('Agrupamento Muralhas do Minho', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text('Disciplina: Ci√™ncias Naturais', 105, 30, { align: 'center' });
      doc.text('Professor: Fernando Cruz', 105, 40, { align: 'center' });
      doc.text('Quiz: Sistema Reprodutor Humano', 105, 50, { align: 'center' });
      
      // Linha separadora
      doc.line(20, 55, 190, 55);
      
      // C√°lculo do resultado
      let correct = 0;
      userAnswers.forEach((answer, i) => {
        if (answer === quizData[i].a) correct++;
      });
      
      const percent = Math.round((correct / quizData.length) * 100);
      let level = "";
      if (percent < 50) level = "N√£o Satisfaz";
      else if (percent < 70) level = "Satisfaz";
      else if (percent < 90) level = "Satisfaz Bastante";
      else level = "Excelente";

      // Informa√ß√µes do aluno e avalia√ß√£o no cabe√ßalho
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`Aluno: ${studentData.name}`, 20, 70);
      doc.text(`N√∫mero: ${studentData.number}`, 20, 80);
      doc.text(`Turma: ${studentData.class}`, 120, 70);
      doc.text(`Data: ${new Date(studentData.date).toLocaleDateString('pt-PT')}`, 120, 80);
      doc.text(`Hora: ${studentData.time}`, 20, 90);
      
      // Avalia√ß√£o no cabe√ßalho
      doc.setFont('helvetica', 'bold');
      doc.text(`Pontua√ß√£o: ${percent}% (${correct}/${quizData.length})`, 120, 90);
      doc.text(`Avalia√ß√£o: ${level}`, 20, 100);
      
      // Linha separadora
      doc.line(20, 105, 190, 105);
      
      // Detalhes das respostas
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text('Resumo das Respostas:', 20, 115);
      
      let yPos = 125;
      doc.setFont('helvetica', 'normal');
      
      quizData.forEach((q, i) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        const user = userAnswers[i];
        const isCorrect = user === q.a;
        
        // Pergunta (quebrar linha se muito longa)
        const questionLines = doc.splitTextToSize(`${i + 1}. ${q.q}`, 170);
        doc.text(questionLines, 20, yPos);
        yPos += questionLines.length * 5;
        
        // Resposta do aluno
        doc.text(`Sua resposta: ${user !== null ? q.o[user] : "Sem resposta"}`, 25, yPos);
        yPos += 5;
        
        // Resposta correta
        doc.text(`Resposta correta: ${q.o[q.a]}`, 25, yPos);
        yPos += 5;
        
        // Status
        doc.setFont('helvetica', 'bold');
        if (isCorrect) {
          doc.setTextColor(0, 128, 0);
          doc.text('‚úì Correto', 25, yPos);
        } else {
          doc.setTextColor(255, 0, 0);
          doc.text('‚úó Incorreto', 25, yPos);
        }
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        yPos += 10;
      });
      
      // Salvar o PDF
      const fileName = `Quiz_${studentData.name.replace(/\s+/g, '_')}_${studentData.number}.pdf`;
      doc.save(fileName);
      
      showSaveStatus('success', '‚úÖ Arquivo PDF exportado com sucesso!');
    }
  </script>
</body>
</html>
